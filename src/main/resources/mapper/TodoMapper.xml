<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.todo.repository.TodoMapper">

    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM todo t
        <where>
            <if test="keyword != null and keyword != ''">
                LOWER(t.title) LIKE CONCAT('%', LOWER(#{keyword}), '%')
            </if>
            <if test="categoryId != null">
                AND t.category_id = #{categoryId}
            </if>
            <if test="authors != null and authors.size() > 0">
                AND t.author IN
                <foreach collection="authors" item="a" open="(" separator="," close=")">
                    #{a}
                </foreach>
            </if>
            <if test="completed != null">
                AND t.completed = #{completed}
            </if>
            <if test="userId != null">
                AND t.user_id = #{userId}
            </if>
        </where>
    </select>

    <resultMap id="TodoResultMap" type="com.example.todo.entity.Todo">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="author" property="author" />
        <result column="title" property="title" />
        <result column="detail" property="detail" />
        <result column="created_at" property="createdAt" />
        <result column="deadline" property="deadline" />
        <result column="completed" property="completed" />
        <result column="category_id" property="categoryId" />
        <association property="category" javaType="com.example.todo.entity.Category">
            <id column="category_id" property="id" />
            <result column="category_name" property="name" />
            <result column="category_color" property="color" />
        </association>
    </resultMap>

    <select id="searchPage" resultMap="TodoResultMap">
        SELECT t.id,
               t.user_id,
               t.author,
               t.title,
               t.detail,
               t.created_at,
               t.deadline,
               t.completed,
               t.category_id,
               c.name AS category_name,
               c.color AS category_color
        FROM todo t
        LEFT JOIN category c ON c.id = t.category_id
        <where>
            <if test="keyword != null and keyword != ''">
                LOWER(t.title) LIKE CONCAT('%', LOWER(#{keyword}), '%')
            </if>
            <if test="categoryId != null">
                AND t.category_id = #{categoryId}
            </if>
            <if test="authors != null and authors.size() > 0">
                AND t.author IN
                <foreach collection="authors" item="a" open="(" separator="," close=")">
                    #{a}
                </foreach>
            </if>
            <if test="completed != null">
                AND t.completed = #{completed}
            </if>
            <if test="userId != null">
                AND t.user_id = #{userId}
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sort == 'createdAtAsc'">created_at ASC</when>
            <when test="sort == 'createdAtDesc'">created_at DESC</when>
            <when test="sort == 'titleAsc'">title ASC</when>
            <when test="sort == 'titleDesc'">title DESC</when>
            <when test="sort == 'completedAsc'">completed ASC</when>
            <when test="sort == 'completedDesc'">completed DESC</when>
            <when test="sort == 'deadlineAsc'">deadline ASC</when>
            <when test="sort == 'deadlineDesc'">deadline DESC</when>
            <otherwise>created_at DESC</otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="searchAll" resultMap="TodoResultMap">
        SELECT t.id,
               t.user_id,
               t.author,
               t.title,
               t.detail,
               t.created_at,
               t.deadline,
               t.completed,
               t.category_id,
               c.name AS category_name,
               c.color AS category_color
        FROM todo t
        LEFT JOIN category c ON c.id = t.category_id
        <where>
            <if test="keyword != null and keyword != ''">
                LOWER(t.title) LIKE CONCAT('%', LOWER(#{keyword}), '%')
            </if>
            <if test="categoryId != null">
                AND t.category_id = #{categoryId}
            </if>
            <if test="authors != null and authors.size() > 0">
                AND t.author IN
                <foreach collection="authors" item="a" open="(" separator="," close=")">
                    #{a}
                </foreach>
            </if>
            <if test="completed != null">
                AND t.completed = #{completed}
            </if>
            <if test="userId != null">
                AND t.user_id = #{userId}
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sort == 'createdAtAsc'">created_at ASC</when>
            <when test="sort == 'createdAtDesc'">created_at DESC</when>
            <when test="sort == 'titleAsc'">title ASC</when>
            <when test="sort == 'titleDesc'">title DESC</when>
            <when test="sort == 'completedAsc'">completed ASC</when>
            <when test="sort == 'completedDesc'">completed DESC</when>
            <when test="sort == 'deadlineAsc'">deadline ASC</when>
            <when test="sort == 'deadlineDesc'">deadline DESC</when>
            <otherwise>created_at DESC</otherwise>
        </choose>
    </select>

    <select id="findAuthors" resultType="string">
        SELECT DISTINCT author
        FROM todo
        <where>
            <if test="userId != null">
                user_id = #{userId}
            </if>
        </where>
        ORDER BY author ASC
    </select>

    <select id="findById" resultMap="TodoResultMap">
        SELECT t.id,
               t.user_id,
               t.author,
               t.title,
               t.detail,
               t.created_at,
               t.deadline,
               t.completed,
               t.category_id,
               c.name AS category_name,
               c.color AS category_color
        FROM todo t
        LEFT JOIN category c ON c.id = t.category_id
        WHERE t.id = #{id}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO todo (user_id, author, title, detail, created_at, completed, category_id, deadline)
        VALUES (#{userId}, #{author}, #{title}, #{detail}, #{createdAt}, #{completed}, #{categoryId}, #{deadline})
    </insert>

    <update id="update">
        UPDATE todo
        SET author = #{author},
            title = #{title},
            detail = #{detail},
            completed = #{completed},
            category_id = #{categoryId},
            deadline = #{deadline}
        WHERE id = #{id}
    </update>

    <update id="updateCompleted">
        UPDATE todo
        SET completed = #{completed}
        WHERE id = #{id}
    </update>

    <delete id="delete">
        DELETE FROM todo
        WHERE id = #{id}
    </delete>

    <delete id="deleteBatch">
        DELETE FROM todo
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="findOwnerId" resultType="long">
        SELECT user_id
        FROM todo
        WHERE id = #{id}
    </select>

</mapper>
